version: '3.8'

services:
  # Fraud Detection Application
  fraud-detector:
    build: .
    container_name: fraud-detector-optionc
    restart: unless-stopped
    depends_on:
      - redis
      - qdrant
    environment:
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Kafka (Confluent Cloud)
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS}
      - KAFKA_API_KEY=${KAFKA_API_KEY}
      - KAFKA_API_SECRET=${KAFKA_API_SECRET}
      - KAFKA_TOPIC_INPUT=${KAFKA_TOPIC_INPUT:-fraud-detection-input}
      - KAFKA_TOPIC_OUTPUT=${KAFKA_TOPIC_OUTPUT:-fraud-detection-output}
      - KAFKA_CONSUMER_GROUP=${KAFKA_CONSUMER_GROUP:-fraud-detection-group}

      # Database (Supabase)
      - POSTGRES_CONNECTION_STRING=${POSTGRES_CONNECTION_STRING}

      # Redis
      - REDIS_URL=redis://redis:6379
      - ENABLE_REDIS=true

      # Qdrant
      - QDRANT_URL=http://qdrant:6333
      - ENABLE_QDRANT=true

      # Langfuse (Optional)
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}

      # Fraud Detection Thresholds
      - FRAUD_BLOCK_THRESHOLD=${FRAUD_BLOCK_THRESHOLD:-0.70}
      - FRAUD_REVIEW_THRESHOLD=${FRAUD_REVIEW_THRESHOLD:-0.40}
      - VELOCITY_THRESHOLD_MS=${VELOCITY_THRESHOLD_MS:-500}
      - MAX_AI_REQUESTS_PER_MIN=${MAX_AI_REQUESTS_PER_MIN:-20}
      - AGENT_TIMEOUT_SECONDS=${AGENT_TIMEOUT_SECONDS:-90}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Agent Framework
      - USE_AGNO_AGENTS=${USE_AGNO_AGENTS:-true}
    networks:
      - fraud-network
    volumes:
      - ./src/agents/prompts:/app/src/agents/prompts  # Mount prompts for easy updates

  # Redis (Memory)
  redis:
    image: redis:7-alpine
    container_name: redis-fraud-optionc
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - fraud-network
    command: redis-server --appendonly yes

  # Qdrant (Vector Database)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant-fraud-optionc
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - fraud-network
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333

networks:
  fraud-network:
    driver: bridge

volumes:
  redis-data:
  qdrant-data:
